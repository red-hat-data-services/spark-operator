# ============================================================================
# OpenShift SCC Guardrails E2E Test
# ============================================================================
name: OpenShift SCC Guardrails E2E

on:
  push:
    branches:
      - main
    paths:
      - 'examples/openshift/k8s/base/validating-admission-policy*.yaml'
      - 'examples/openshift/tests/test-invalid-fsgroup.sh'
      - 'examples/openshift/tests/invalid-fsgroup.yaml'
      - '.github/workflows/openshift-scc-guardrails.yaml'
  pull_request:
    paths:
      - 'examples/openshift/k8s/base/validating-admission-policy*.yaml'
      - 'examples/openshift/tests/test-invalid-fsgroup.sh'
      - 'examples/openshift/tests/invalid-fsgroup.yaml'
      - '.github/workflows/openshift-scc-guardrails.yaml'
  workflow_dispatch:
jobs:
  scc-guardrails-e2e:
    name: SCC Guardrails E2E Test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ======================================================================
      # Step 1: Checkout code
      # ======================================================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ======================================================================
      # Step 2: Setup Kind cluster (using composite action)
      # ======================================================================
      - name: Setup Kind cluster
        uses: ./.github/actions/kind-cluster-setup

      # ======================================================================
      # Step 3: Run operator install test
      # ======================================================================
      - name: Run operator install test
        working-directory: examples/openshift/tests
        run: |
          echo "Running operator install test..."
          chmod +x test-operator-install.sh
          CLEANUP=false ./test-operator-install.sh

      # ======================================================================
      # Step 4: Install ValidatingAdmissionPolicy
      # ======================================================================
      - name: Install ValidatingAdmissionPolicy
        working-directory: examples/openshift
        run: |
          echo "Installing ValidatingAdmissionPolicy..."
          
          # Check API availability
          if ! kubectl api-resources | grep -q "validatingadmissionpolicies"; then
            echo "::error::ValidatingAdmissionPolicy API not found."
            exit 1
          fi

          # Ensure your YAML files use apiVersion: admissionregistration.k8s.io/v1
          kubectl apply -f k8s/base/validating-admission-policy.yaml
          kubectl apply -f k8s/base/validating-admission-policy-binding.yaml
          
          echo "âœ… Policy installed successfully"

      # ======================================================================
      # Step 5: Run SCC guardrails test
      # ======================================================================
      - name: Run SCC guardrails test
        working-directory: examples/openshift/tests
        run: |
          chmod +x test-invalid-fsgroup.sh
          ./test-invalid-fsgroup.sh

      # ======================================================================
      # Debug: Show cluster state on failure
      # ======================================================================
      - name: Debug - Show cluster state
        if: failure()
        run: |
          kubectl get pods -A
          kubectl get validatingadmissionpolicies -o yaml 2>/dev/null || echo "No Policies found"
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50
